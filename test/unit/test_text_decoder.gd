# Copyright (c) 2020 The GodotXterm authors.
# Copyright (c) 2019 The xterm.js authors. All rights reserved.
# License MIT
extends 'res://addons/gut/test.gd'

const Decoder = preload("res://addons/godot_xterm/input/text_decoder.gd")

# Note: There might be some invisible characters (such as emoji) depending
# on your editor and font settings.
const TEST_STRINGS = [
	"Ð›Ð¾Ñ€ÐµÐ¼ Ð¸Ð¿ÑÑƒÐ¼ Ð´Ð¾Ð»Ð¾Ñ€ ÑÐ¸Ñ‚ Ð°Ð¼ÐµÑ‚, ÐµÑ… ÑÐµÐ° Ð°Ñ†Ñ†ÑƒÑÐ°Ð¼ Ð´Ð¸ÑÑÐµÐ½Ñ‚Ð¸ÐµÑ‚. ÐÐ½ ÐµÐ¾Ñ ÑÑ‚ÐµÑ‚ ÐµÐ¸Ñ€Ð¼Ð¾Ð´ Ð²Ð¸Ñ‚ÑƒÐ¿ÐµÑ€Ð°Ñ‚Ð°. Ð˜ÑƒÑ Ð´Ð¸Ñ†ÐµÑ€ÐµÑ‚ ÑƒÑ€Ð±Ð°Ð½Ð¸Ñ‚Ð°Ñ ÐµÑ‚. ÐÐ½ Ð¿Ñ€Ð¸ Ð°Ð»Ñ‚ÐµÑ€Ð° Ð´Ð¾Ð»Ð¾Ñ€ÐµÑ ÑÐ¿Ð»ÐµÐ½Ð´Ð¸Ð´Ðµ, Ñ†Ñƒ ÑÑƒÐ¾ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ðµ Ð´ÐµÐ½Ð¸ÑÑƒÐµ, Ð¸Ð³Ð½Ð¾Ñ‚Ð° Ð²Ð¾Ð»ÑƒÐ¿Ñ‚Ð°Ñ€Ð¸Ð° Ð¸Ð½ÑÑ‚Ñ€ÑƒÑ†Ñ‚Ð¸Ð¾Ñ€ Ñ†Ñƒ Ð²Ð¸Ð¼.",
	"áƒšáƒáƒ áƒ”áƒ› áƒ˜áƒ¤áƒ¡áƒ£áƒ› áƒ“áƒáƒšáƒáƒ  áƒ¡áƒ˜áƒ— áƒáƒ›áƒ”áƒ—, áƒ¤áƒáƒªáƒ”áƒ  áƒ›áƒ£áƒªáƒ˜áƒ£áƒ¡ áƒªáƒáƒœáƒ¡áƒ”áƒ—áƒ”áƒ—áƒ£áƒ  áƒ§áƒ£áƒ áƒ˜áƒ“, áƒ¤áƒ”áƒ  áƒ•áƒ˜áƒ•áƒ”áƒœáƒ“áƒ£áƒ› áƒ§áƒ£áƒáƒ”áƒ áƒ”áƒœáƒ“áƒ£áƒ› áƒ”áƒ, áƒ”áƒ¡áƒ— áƒáƒ›áƒ”áƒ— áƒ›áƒáƒ•áƒ”áƒ— áƒ¡áƒ£áƒáƒ•áƒ˜áƒ—áƒáƒ—áƒ” áƒªáƒ£. áƒ•áƒ˜áƒ—áƒáƒ” áƒ¡áƒ”áƒœáƒ¡áƒ˜áƒ‘áƒ£áƒ¡ áƒáƒœ áƒ•áƒ˜áƒ®. áƒ”áƒ®áƒ”áƒ áƒªáƒ˜ áƒ“áƒ”áƒ—áƒ”áƒ áƒ áƒ£áƒ˜áƒ¡áƒ¡áƒ”áƒ— áƒ£áƒ— áƒ§áƒ£áƒ˜. áƒ•áƒáƒªáƒ”áƒœáƒ— áƒ“áƒ”áƒ‘áƒ˜áƒ—áƒ˜áƒ¡ áƒáƒ“áƒ˜áƒ¤áƒ˜áƒ¡áƒªáƒ˜ áƒ”áƒ— áƒ¤áƒ”áƒ . áƒœáƒ”áƒª áƒáƒœ áƒ¤áƒ”áƒ£áƒ’áƒáƒ˜áƒ— áƒ¤áƒáƒ áƒ”áƒœáƒ¡áƒ˜áƒ‘áƒ£áƒ¡ áƒ˜áƒœáƒ—áƒ”áƒ áƒ”áƒ¡áƒ¡áƒ”áƒ—. áƒ˜áƒ“ áƒ“áƒ˜áƒªáƒ áƒ áƒ˜áƒ“áƒ”áƒœáƒ¡ áƒ˜áƒ£áƒ¡. áƒ“áƒ˜áƒ¡áƒ¡áƒ”áƒœáƒ—áƒ˜áƒ”áƒ— áƒªáƒáƒœáƒ¡áƒ”áƒ§áƒ£áƒ£áƒœáƒ—áƒ£áƒ  áƒ¡áƒ”áƒ“ áƒœáƒ”, áƒœáƒáƒ•áƒ£áƒ› áƒ›áƒ£áƒœáƒ”áƒ áƒ” áƒ”áƒ£áƒ› áƒáƒ—, áƒœáƒ” áƒ”áƒ£áƒ› áƒœáƒ˜áƒ°áƒ˜áƒš áƒ˜áƒ áƒáƒªáƒ£áƒœáƒ“áƒ˜áƒ áƒ£áƒ áƒ‘áƒáƒœáƒ˜áƒ—áƒáƒ¡.",
	"à¤…à¤§à¤¿à¤•à¤¾à¤‚à¤¶ à¤…à¤®à¤¿à¤¤à¤•à¥à¤®à¤¾à¤° à¤ªà¥à¤°à¥‹à¤¤à¥à¤¸à¤¾à¤¹à¤¿à¤¤ à¤®à¥à¤–à¥à¤¯ à¤œà¤¾à¤¨à¥‡ à¤ªà¥à¤°à¤¸à¤¾à¤°à¤¨ à¤µà¤¿à¤¶à¥à¤²à¥‡à¤·à¤£ à¤µà¤¿à¤¶à¥à¤µ à¤¦à¤¾à¤°à¥€ à¤…à¤¨à¥à¤µà¤¾à¤¦à¤• à¤…à¤§à¤¿à¤•à¤¾à¤‚à¤¶ à¤¨à¤µà¤‚à¤¬à¤° à¤µà¤¿à¤·à¤¯ à¤—à¤Ÿà¤•à¤‰à¤¸à¤¿ à¤—à¥‹à¤ªà¤¨à¥€à¤¯à¤¤à¤¾ à¤µà¤¿à¤•à¤¾à¤¸ à¤œà¤¨à¤¿à¤¤ à¤ªà¤°à¤¸à¥à¤ªà¤° à¤—à¤Ÿà¤•à¤‰à¤¸à¤¿ à¤…à¤¨à¥à¤¤à¤°à¤°à¤¾à¤·à¥à¤Ÿà¥à¤°à¥€à¤¯à¤•à¤°à¤¨ à¤¹à¥‹à¤¸à¤•à¥‡ à¤®à¤¾à¤¨à¤µ à¤ªà¥à¤°à¥à¤£à¤¤à¤¾ à¤•à¤®à¥à¤ªà¥à¤¯à¥à¤Ÿà¤° à¤¯à¤¨à¥à¤¤à¥à¤°à¤¾à¤²à¤¯ à¤ªà¥à¤°à¤¤à¤¿ à¤¸à¤¾à¤§à¤¨",
	"è¦§å…­å­å½“èžç¤¾è¨ˆæ–‡è­·è¡Œæƒ…æŠ•èº«æ–—æ¥ã€‚å¢—è½ä¸–çš„æ³ä¸Šå¸­å‚™ç•Œå…ˆé–¢æ¨©èƒ½ä¸‡ã€‚æœ¬ç‰©æŒ™æ­¯ä¹³å…¨äº‹æºä¾›æ¿æ ƒæžœä»¥ã€‚é ­æœˆæ‚£ç«¯æ’¤ç«¶è¦‹ç•Œè¨˜å¼•åŽ»æ³•æ¡å…¬æ³Šå€™ã€‚æ±ºæµ·å‚™é§†å–å“ç›®èŠ¸æ–¹ç”¨æœç¤ºä¸Šç”¨å ±ã€‚è¬›ç”³å‹™ç´™ç´„é€±å ‚å‡ºå¿œç†ç”°æµå›£å¹¸ç¨¿ã€‚èµ·ä¿å¸¯å‰å¯¾é˜œåº­æ”¯è‚¯è±ªå½°å±žæœ¬èºã€‚é‡æŠ‘ç†Šäº‹åºœå‹Ÿå‹•æ¥µéƒ½æŽ²ä»®èª­å²¸ã€‚è‡ªç¶šå·¥å°±æ–­åº«æŒ‡åŒ—é€Ÿé…é³´ç´„äº‹æ–°ä½ç±³ä¿¡ä¸­é¨“ã€‚å©šæµœè¢‹è‘—é‡‘å¸‚ç”Ÿäº¤ä¿ä»–å–æƒ…è·ã€‚",
	"å…«ãƒ¡ãƒ«å‹™å•ã¸ãµã‚‰ãåšè¾žèª¬ã„ã‚ã‚‡èª­å…¨ã‚¿ãƒ¨ãƒ ã‚±æ±æ ¡ã©ã£çŸ¥å£ãƒ†ã‚±ç¦åŽ»ãƒ•ãƒŸäººéŽã‚’è£…5éšŽãŒã­ãœæ³•é€†ã¯ã˜ç«¯40è½ãƒŸäºˆç«¹ãƒžãƒ˜ãƒŠã‚»ä»»1æ‚ªãŸã€‚çœãœã‚Šã›è£½æš‡ã‚‡ã¸ãã‘é¢¨äº•ã‚¤åŠ£æ‰‹ã¯ã¼ã¾ãšéƒµå¯Œæ³•ãä½œæ–­ã‚¿ã‚ªã‚¤å–åº§ã‚…ã‚‡ãŒå‡ºä½œãƒ›ã‚·æœˆçµ¦26å³¶ãƒ„ãƒçš‡é¢ãƒ¦ãƒˆã‚¯ã‚¤æš®çŠ¯ãƒªãƒ¯ãƒŠãƒ¤æ–­é€£ã“ã†ã§ã¤è”­æŸ”è–„ã¨ãƒ¬ã«ã®ã€‚æ¼”ã‚ã‘ãµã±æç”°è»¢10å¾—è¦³ã³ãƒˆã’ãŽçŽ‹ç‰©é‰„å¤œãŒã¾ã‘ç†æƒœãã¡ç‰¡æã¥è»Šæƒ‘å‚ãƒ˜ã‚«ãƒ¦ãƒ¢é•·è‡“è¶…æ¼«ã¼ãƒ‰ã‹ã‚ã€‚",
	"ëª¨ë“  êµ­ë¯¼ì€ í–‰ìœ„ì‹œì˜ ë²•ë¥ ì— ì˜í•˜ì—¬ ë²”ì£„ë¥¼ êµ¬ì„±í•˜ì§€ ì•„ë‹ˆí•˜ëŠ” í–‰ìœ„ë¡œ ì†Œì¶”ë˜ì§€ ì•„ë‹ˆí•˜ë©°. ì „ì§ëŒ€í†µë ¹ì˜ ì‹ ë¶„ê³¼ ì˜ˆìš°ì— ê´€í•˜ì—¬ëŠ” ë²•ë¥ ë¡œ ì •í•œë‹¤, êµ­íšŒëŠ” í—Œë²• ë˜ëŠ” ë²•ë¥ ì— íŠ¹ë³„í•œ ê·œì •ì´ ì—†ëŠ” í•œ ìž¬ì ì˜ì› ê³¼ë°˜ìˆ˜ì˜ ì¶œì„ê³¼ ì¶œì„ì˜ì› ê³¼ë°˜ìˆ˜ì˜ ì°¬ì„±ìœ¼ë¡œ ì˜ê²°í•œë‹¤. êµ°ì¸Â·êµ°ë¬´ì›Â·ê²½ì°°ê³µë¬´ì› ê¸°íƒ€ ë²•ë¥ ì´ ì •í•˜ëŠ” ìžê°€ ì „íˆ¬Â·í›ˆë ¨ë“± ì§ë¬´ì§‘í–‰ê³¼ ê´€ë ¨í•˜ì—¬ ë°›ì€ ì†í•´ì— ëŒ€í•˜ì—¬ëŠ” ë²•ë¥ ì´ ì •í•˜ëŠ” ë³´ìƒì™¸ì— êµ­ê°€ ë˜ëŠ” ê³µê³µë‹¨ì²´ì— ê³µë¬´ì›ì˜ ì§ë¬´ìƒ ë¶ˆë²•í–‰ìœ„ë¡œ ì¸í•œ ë°°ìƒì€ ì²­êµ¬í•  ìˆ˜ ì—†ë‹¤.",
	"ÙƒØ§Ù† ÙØ´ÙƒÙ‘Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ Ù…Ø¹, ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ù…Ø¬Ù‡ÙˆØ¯ ØªØ²Ø§Ù…Ù†Ø§Ù‹ Ø¨Ø¹Ø¶ Ø¨Ù„. ÙˆØªÙ… Ø¬Ù†ÙˆØ¨ Ù„Ù„ØµÙŠÙ† ØºÙŠÙ†ÙŠØ§ Ù„Ù…, Ø§Ù† ÙˆØ¨Ø¯ÙˆÙ† ÙˆÙƒØ³Ø¨Øª Ø§Ù„Ø£Ù…ÙˆØ± Ø°Ù„Ùƒ, Ø£Ø³Ø± Ø§Ù„Ø®Ø§Ø³Ø± Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ù‡Ùˆ. Ù†ÙØ³ Ù„ØºØ²Ùˆ Ù…ÙˆØ§Ù‚Ø¹Ù‡Ø§ Ù‡Ùˆ. Ø§Ù„Ø¬Ùˆ Ø¹Ù„Ø§Ù‚Ø© Ø§Ù„ØµØ¹Ø¯Ø§Ø¡ Ø§Ù†Ù‡ Ø£ÙŠ, ÙƒÙ…Ø§ Ù…Ø¹ Ø¨Ù…Ø¨Ø§Ø±ÙƒØ© Ù„Ù„Ø¥ØªØ­Ø§Ø¯ Ø§Ù„ÙˆØ²Ø±Ø§Ø¡. ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø£Ù† Ø­Ø¯Ù‰, Ø§Ù„Ø´ØªÙˆÙŠØ© Ø¨Ø§Ø³ØªØ­Ø¯Ø§Ø« Ù…Ø¯Ù† Ø¨Ù„, ÙƒØ§Ù† Ù‚Ø¯ Ø£ÙˆØ³Ø¹ Ø¹Ù…Ù„ÙŠØ©. Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø¨Ø§Ù„Ù…Ø·Ø§Ù„Ø¨Ø© ÙƒÙ„ Ù‚Ø§Ù…, Ø¯ÙˆÙ† Ø¥Ø° Ø´Ù…Ø§Ù„ Ø§Ù„Ø±Ø¨ÙŠØ¹ØŒ. Ù‡ÙØ²Ù… Ø§Ù„Ø®Ø§ØµÙ‘Ø© Ù£Ù  Ø£Ù…Ø§, Ù…Ø§ÙŠÙˆ Ø§Ù„ØµÙŠÙ†ÙŠØ© Ù…Ø¹ Ù‚Ø¨Ù„.",
	"××• ×¡×“×¨ ×”×—×•×œ ×ž×™×–×ž×™ ×§×¨×™×ž×™× ×•×œ×•×’×™×”. ×§×”×™×œ×” ×‘×’×¨×¡×” ×œ×•×™×§×™×¤×“×™× ××œ ×”×™×, ×©×œ ×¦×¢×“ ×¦×™×•×¨ ×•××œ×§×˜×¨×•× ×™×§×”. ×ž×“×¢ ×ž×” ×‘×¨×™×ª ×”×ž×–× ×•×Ÿ ××¨×›×™××•×œ×•×’×™×”, ××œ ×˜×‘×œ××•×ª ×ž×‘×•×§×©×™× ×›×œ×œ. ×ž××ž×¨×©×™×—×”×¦×¤×” ×”×¢×¨×™×›×”×’×™×¨×¡××•×ª ×©×›×œ ××œ, ×›×ª×‘ ×¢×™×¦×•×‘ ×ž×•×©×’×™ ×©×œ. ×§×‘×œ×• ×§×œ××¡×™×™× ×‘ ×ž×ª×Ÿ. × ×‘×—×¨×™× ××•×•×™×¨×•× ××•×˜×™×§×” ×× ×ž×œ×, ×œ×•×— ×œ×ž× ×•×¢ ××¨×›×™××•×œ×•×’×™×” ×ž×”. ××¨×¥ ×œ×¢×¨×•×š ×‘×§×¨×‘×ª ×ž×•× ×—×•× ×™× ××•, ×¢×–×¨×” ×¨×§×˜×•×ª ×œ×•×™×§×™×¤×“×™× ××—×¨ ×’×.",
	"Ð›Ð¾Ñ€ÐµÐ¼ áƒšáƒáƒ áƒ”áƒ› à¤…à¤§à¤¿à¤•à¤¾à¤‚à¤¶ è¦§å…­å­ å…«ãƒ¡ãƒ« ëª¨ë“  ×‘×§×¨×‘×ª ðŸ’® ðŸ˜‚ Ã¤ggg 123â‚¬ ð„ž.",
]

func test_utf32_to_utf8():
	# 1 byte utf8 character
	assert_eq(
		Decoder.utf32_to_utf8(0x00000061),
		PoolByteArray([0x61])
	)
	# 2 byte utf8 character
	assert_eq(
		Decoder.utf32_to_utf8(0x00000761),
		PoolByteArray([0xdd, 0xa1])
	)
	# 3 byte utf8 character
	assert_eq(
		Decoder.utf32_to_utf8(0x00002621),
		PoolByteArray([0xe2, 0x98, 0xa1])
	)
	# 4 byte utf8 character
	assert_eq(
		Decoder.utf32_to_utf8(0x00010144),
		PoolByteArray([0xf0, 0x90, 0x85, 0x84])
	)
	assert_eq(
		Decoder.utf32_to_utf8(0x0001f427) as Array,
		PoolByteArray([0xf0, 0x9f, 0x90, 0xa7]) as Array
	)

func test_string_from_codepoint():
	assert_eq(Decoder.string_from_codepoint(49), '1')
	assert_eq(Decoder.string_from_codepoint(0x1f427), 'ðŸ§')
	assert_eq(Decoder.string_from_codepoint(0x1d11e), 'ð„ž')

func test_utf32_to_string():
	assert_eq(
		Decoder.utf32_to_string([49, 50, 51, 0x1d11e, 49, 50, 51]),
		'123ð„ž123'
	)

class TestUtf8ToUtf32Decoder:
	extends 'res://addons/gut/test.gd'
	
	var decoder = Decoder.Utf8ToUtf32.new()
	var target = []
	
	func before_each():
		decoder.clear()
		target.clear()
		target.resize(5)
	
	func skip_test_full_code_point_0_to_65535(): # 1/2/3 byte sequences
		for i in range(65536):
			# skip surrogate pairs
			if i >= 0xD800 and i <= 0xDFFF:
				continue
			var utf8_data = Decoder.utf32_to_utf8(i)
			var length = decoder.decode(utf8_data, target)
			assert_eq(length, 1)
			assert_eq(
				Decoder.string_from_codepoint(target[0]),
				utf8_data.get_string_from_utf8()
			)
			decoder.clear()
	
	func skip_test_full_codepoint_65536_to_0x10FFFF(): # 4 byte sequences
		for i in range(65536, 0x10FFFF):
			var utf8_data = Decoder.utf32_to_utf8(i)
			var length = decoder.decode(utf8_data, target)
			assert_eq(length, 1)
			assert_eq(target[0], i)
	
	func test_test_strings():
		target.resize(500)
		for string in TEST_STRINGS:
			var utf8_data = string.to_utf8()
			var length = decoder.decode(utf8_data, target)
			assert_eq(Decoder.utf32_to_string(target, 0, length), string)
			decoder.clear()
